<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>快递单号扫描</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #F2F2F7;
            color: #1C1C1E;
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-scale-up { animation: scaleUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 选中状态的 Tab 背景动画 */
        .tab-active { background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #000; font-weight: 600; }
        .tab-inactive { color: #666; font-weight: 500; }

        /* 日历样式 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; position: relative; font-size: 14px; font-weight: 500; color: #333; }
        .calendar-day.empty { background: transparent; pointer-events: none; }
        .calendar-day.active { background-color: white; }
        .calendar-day.selected { border: 2px solid #2563EB; background-color: #EFF6FF; }
        .calendar-day.today { color: #2563EB; font-weight: 900; background-color: #EFF6FF; }
        .calendar-dot { width: 4px; height: 4px; border-radius: 50%; background-color: #2563EB; margin-top: 2px; }
        .calendar-count { font-size: 10px; color: #6B7280; margin-top: 0px; transform: scale(0.9); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 图标组件 ---
        const Icons = {
            Camera: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Plus: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash2: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            CheckCircle: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Search: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            BarChart: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            Settings: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            X: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Download: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Upload: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Calendar: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            TrendingUp: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            ChevronLeft: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            ChevronDown: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            ChevronUp: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>,
            Filter: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            Today: ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M12 14h.01"/></svg>,
            Maximize: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        };

        const BatchScannerStats = () => {
            // --- 核心数据 ---
            const [packages, setPackages] = useState(() => {
                try {
                    const saved = localStorage.getItem('stats_packages');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            const [goodsList, setGoodsList] = useState(() => {
                try {
                    const saved = localStorage.getItem('stats_goods_list');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            // --- UI 状态 ---
            const [activeTab, setActiveTab] = useState('list'); 
            
            // 统计相关
            const [statsMode, setStatsMode] = useState('month');
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [selectedGood, setSelectedGood] = useState(null); 
            const [selectedDayDetail, setSelectedDayDetail] = useState(null);
            const [isGoodsExpanded, setIsGoodsExpanded] = useState(false);

            const [isBatchModalOpen, setIsBatchModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [filterType, setFilterType] = useState('pending');
            const [analyzing, setAnalyzing] = useState(false);
            const [deleteTargetId, setDeleteTargetId] = useState(null);
            const fileInputRef = useRef(null);

            // 批量录入相关
            const [batchItems, setBatchItems] = useState([]); 
            const [globalFill, setGlobalFill] = useState({ content: '', quantity: 1, sender: '', phone: '' });
            const [manualInputCode, setManualInputCode] = useState('');
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [currentEditingIndex, setCurrentEditingIndex] = useState(null);
            
            // 图片预览
            const [scannedImage, setScannedImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(false);

            useEffect(() => { localStorage.setItem('stats_packages', JSON.stringify(packages)); }, [packages]);
            useEffect(() => { localStorage.setItem('stats_goods_list', JSON.stringify(goodsList)); }, [goodsList]);

            const updateGoodsLibrary = (newItem) => {
                if (!newItem) return;
                const item = newItem.trim();
                if (!item) return;
                let newList = goodsList.filter(g => g !== item);
                newList.unshift(item);
                if (newList.length > 50) newList = newList.slice(0, 50);
                setGoodsList(newList);
            };

            const removeGood = (good) => {
                if (confirm(`确定从常用库删除“${good}”吗？`)) {
                    setGoodsList(goodsList.filter(g => g !== good));
                }
            };

            // --- 核心：状态更新逻辑优化 (记录核验时间) ---
            const toggleVerify = (id) => {
                setPackages(prev => prev.map(p => {
                    if (p.id === id) {
                        const isVerifying = !p.verified;
                        return {
                            ...p,
                            verified: isVerifying,
                            verifiedTime: isVerifying ? Date.now() : undefined // 记录/清除 核验时间
                        };
                    }
                    return p;
                }));
            };

            // --- 统计数据计算 (逻辑重构：分离添加与实收) ---
            const statsData = useMemo(() => {
                // 1. 货物筛选
                let filteredData = packages;
                if (selectedGood) filteredData = packages.filter(p => p.content.includes(selectedGood));

                // 2. 计算核心指标
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).getTime();
                
                const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                const thisMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).getTime();
                
                const thisYearStart = new Date(now.getFullYear(), 0, 1).getTime();
                const thisYearEnd = new Date(now.getFullYear(), 11, 31, 23, 59, 59).getTime();

                // 辅助：获取有效的核验时间 (兼容旧数据：如果verified=true但没verifiedTime，暂用timestamp替代，确保老数据不丢失)
                const getVerifyTime = (p) => p.verifiedTime || p.timestamp;

                const summary = {
                    // 今日添加：仅基于 timestamp (录入时间)
                    todayAdded: filteredData.filter(p => p.timestamp >= todayStart && p.timestamp <= todayEnd).reduce((sum, p) => sum + (Number(p.quantity)||1), 0),
                    
                    // 今日实收：基于 verifiedTime (核验时间)
                    todayReceived: filteredData.filter(p => p.verified && getVerifyTime(p) >= todayStart && getVerifyTime(p) <= todayEnd).reduce((sum, p) => sum + (Number(p.quantity)||1), 0),
                    
                    // 本月实收
                    monthReceived: filteredData.filter(p => p.verified && getVerifyTime(p) >= thisMonthStart && getVerifyTime(p) <= thisMonthEnd).reduce((sum, p) => sum + (Number(p.quantity)||1), 0),
                    
                    // 本年实收
                    yearReceived: filteredData.filter(p => p.verified && getVerifyTime(p) >= thisYearStart && getVerifyTime(p) <= thisYearEnd).reduce((sum, p) => sum + (Number(p.quantity)||1), 0),
                };

                // 3. 准备日历/图表数据 (基于 currentDate 导航)
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayObj = new Date(year, month, 1);
                const startWeekDay = firstDayObj.getDay();
                
                // 构建日历数据 (日历视图展示的是“实收”情况，所以用 verifiedTime)
                // 用户需求是“看到各个货物单独的每日的总出库(收到)数量”，所以日历应反映“收到”的时间
                const calendarDays = [];
                for (let i = 0; i < startWeekDay; i++) calendarDays.push({ empty: true });
                for (let d = 1; d <= daysInMonth; d++) {
                    const dayStart = new Date(year, month, d).getTime();
                    const dayEnd = new Date(year, month, d, 23, 59, 59).getTime();
                    
                    // 筛选当日“收到”的包裹
                    const dayPackages = filteredData.filter(p => p.verified && getVerifyTime(p) >= dayStart && getVerifyTime(p) <= dayEnd);
                    const totalQuantity = dayPackages.reduce((sum, p) => sum + (Number(p.quantity) || 1), 0);
                    
                    calendarDays.push({ day: d, date: new Date(year, month, d), count: totalQuantity, packages: dayPackages, hasData: totalQuantity > 0 });
                }

                // 构建年度数据
                const yearMonths = [];
                let viewYearTotal = 0; 
                for (let m = 0; m < 12; m++) {
                    const mStart = new Date(year, m, 1).getTime();
                    const mEnd = new Date(year, m + 1, 0, 23, 59, 59).getTime();
                    const mPackages = filteredData.filter(p => p.verified && getVerifyTime(p) >= mStart && getVerifyTime(p) <= mEnd);
                    const mTotal = mPackages.reduce((sum, p) => sum + (Number(p.quantity) || 1), 0);
                    yearMonths.push({ month: m + 1, value: mTotal });
                    viewYearTotal += mTotal;
                }

                return { calendarDays, yearMonths, viewYearTotal, summary };
            }, [packages, currentDate, selectedGood]);

            // ... 其他辅助函数 ...
            const navigateDate = (direction) => {
                const newDate = new Date(currentDate);
                if (statsMode === 'month') newDate.setMonth(newDate.getMonth() + direction);
                else newDate.setFullYear(newDate.getFullYear() + direction);
                setCurrentDate(newDate);
                setSelectedDayDetail(null);
            };

            const goToToday = () => {
                setCurrentDate(new Date());
                setSelectedDayDetail(null);
            };

            const currentTitle = useMemo(() => {
                if (statsMode === 'month') return `${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`;
                return `${currentDate.getFullYear()}年`;
            }, [currentDate, statsMode]);

            // 详情列表使用已经计算好的 calendarDays 中的 packages，不需要重复计算，简化逻辑
            const selectedDayPackages = useMemo(() => {
                if (!selectedDayDetail || statsMode !== 'month') return [];
                // 从 calendarDays 中找到对应日期的数据 (这需要 calendarDays 在 useMemo 外部或重新查找)
                // 为简单起见，这里重新过滤一次，逻辑与 statsData 中一致
                const d = new Date(selectedDayDetail);
                const dayStart = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
                const dayEnd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59).getTime();
                const getVerifyTime = (p) => p.verifiedTime || p.timestamp;
                
                let data = packages.filter(p => p.verified && getVerifyTime(p) >= dayStart && getVerifyTime(p) <= dayEnd);
                if (selectedGood) data = data.filter(p => p.content.includes(selectedGood));
                return data;
            }, [selectedDayDetail, packages, selectedGood, statsMode]);

            // ... 核心功能函数 ...
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => setScannedImage(ev.target.result);
                reader.readAsDataURL(file);
                setAnalyzing(true);
                try {
                    const imgBitmap = await createImageBitmap(file);
                    if ('BarcodeDetector' in window) {
                        try {
                            const detector = new window.BarcodeDetector({ formats: ['code_128', 'code_39', 'ean_13', 'qr_code'] });
                            const detected = await detector.detect(imgBitmap);
                            const codes = [...new Set(detected.map(d => d.rawValue))].filter(c => c.length > 8);
                            if (codes.length > 0) {
                                const newItems = codes.map(code => ({ _tempId: Date.now() + Math.random(), tracking: code, content: globalFill.content, quantity: globalFill.quantity }));
                                const existingCodes = new Set(batchItems.map(i => i.tracking));
                                const uniqueNewItems = newItems.filter(i => !existingCodes.has(i.tracking));
                                setBatchItems([...batchItems, ...uniqueNewItems]);
                            } else { alert("未识别到清晰条码，请手动输入"); }
                        } catch (e) { alert("扫码组件启动失败，请检查浏览器兼容性或使用 HTTPS。"); }
                    } else { alert("浏览器不支持原生扫码，建议使用 Chrome/Edge。"); }
                } catch (err) { alert("识别出错: " + err.message); } finally { setAnalyzing(false); e.target.value = ''; }
            };

            const addManualCode = () => {
                if (!manualInputCode) return;
                if (batchItems.some(i => i.tracking === manualInputCode)) return alert('已存在');
                setBatchItems([...batchItems, { _tempId: Date.now(), tracking: manualInputCode, content: globalFill.content, quantity: globalFill.quantity }]);
                setManualInputCode('');
            };
            const applyGlobalToAll = () => { setBatchItems(prev => prev.map(item => ({ ...item, content: globalFill.content || item.content, quantity: globalFill.quantity || item.quantity }))); };
            const updateBatchItem = (index, field, value) => { setBatchItems(prevItems => prevItems.map((item, i) => i === index ? { ...item, [field]: value } : item)); };
            const removeBatchItem = (index) => { setBatchItems(prevItems => prevItems.filter((_, i) => i !== index)); };
            const saveBatch = () => {
                if (batchItems.length === 0) return alert("无单号");
                if (batchItems.some(i => !i.content)) return alert("有单号未填货物名");
                batchItems.forEach(i => updateGoodsLibrary(i.content));
                const newPackages = batchItems.map(item => ({ id: Date.now() + Math.random(), tracking: item.tracking, content: item.content, quantity: Number(item.quantity)||1, sender: globalFill.sender||'未知', phone: globalFill.phone||'未知', verified: false, timestamp: Date.now() }));
                setPackages([...newPackages, ...packages]);
                setIsBatchModalOpen(false); setBatchItems([]); setScannedImage(null);
            };
            const closeBatchModal = () => { setIsBatchModalOpen(false); setScannedImage(null); setBatchItems([]); };
            
            const confirmDelete = () => { setPackages(prev => prev.filter(p => p.id !== deleteTargetId)); setDeleteTargetId(null); };

            // --- 优化后的备份导出函数 ---
            const exportBackup = () => {
                try { 
                    const blob = new Blob([JSON.stringify({version:'2.0', packages, goodsList}, null, 2)], {type: 'application/json'}); 
                    const a = document.createElement('a'); 
                    a.href = URL.createObjectURL(blob); 
                    
                    // 获取当前本地日期 yyyy-mm-dd
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    // 命名格式：App名称_Backup_yyyy-mm-dd
                    a.download = `ScanKuaid_Backup_${dateStr}.json`; 
                    
                    document.body.appendChild(a); 
                    a.click(); 
                    document.body.removeChild(a); 
                } catch(e) { alert("备份失败"); }
            };

            const handleRestore = (e) => {
                const reader = new FileReader(); reader.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if (confirm(`恢复 ${data.packages?.length||0} 条数据？`)) { if(data.packages) setPackages(data.packages); if(data.goodsList) setGoodsList(data.goodsList); alert("恢复成功"); setIsSettingsOpen(false); } } catch(err) { alert("文件错误"); } }; if(e.target.files[0]) reader.readAsText(e.target.files[0]); e.target.value = '';
            };
            const exportExcel = () => {
                try { if (packages.length === 0) return alert('暂无数据'); let csv = "运单号,货物,数量,发货地,手机,状态,时间\n"; packages.forEach(p => { csv += `${p.tracking},${(p.content||'').replace(/,/g,' ')},${p.quantity || 1},${p.sender},${p.phone},${p.verified?'已核验':'待收货'},${new Date(p.timestamp).toLocaleString()}\n`; }); const blob = new Blob(["\ufeff"+csv], {type: 'text/csv;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `List_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); } catch(e) { alert("导出失败"); }
            };
            const filteredPackages = useMemo(() => { return packages.filter(p => { const match = (p.tracking + p.content + p.sender + p.phone).toLowerCase().includes(searchQuery.toLowerCase()); return match && (filterType === 'pending' ? !p.verified : p.verified); }); }, [packages, searchQuery, filterType]);
            const filteredGoods = useMemo(() => { const target = currentEditingIndex === 'global' ? globalFill.content : (batchItems[currentEditingIndex]?.content || ''); if (!target) return goodsList; return goodsList.filter(g => g.toLowerCase().includes(target.toLowerCase())); }, [goodsList, globalFill.content, batchItems, currentEditingIndex]);

            return (
                <div className="min-h-screen pb-32 relative">
                    
                    {/* 顶部导航 */}
                    <div className="sticky top-0 z-30 bg-[#F2F2F7]/90 backdrop-blur-md border-b border-gray-200 pt-safe-top">
                        <div className="px-4 py-3 flex justify-between items-center">
                            <h1 className="text-xl font-bold tracking-tight">快递单号扫描</h1>
                            <div className="flex gap-4">
                                <button onClick={() => setActiveTab(activeTab === 'list' ? 'stats' : 'list')} className={`p-2 transition-colors ${activeTab === 'stats' ? 'text-blue-600 bg-blue-100 rounded-full' : 'text-gray-500'}`}>
                                    <Icons.BarChart size={22} />
                                </button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-blue-600">
                                    <Icons.Settings size={22} />
                                </button>
                            </div>
                        </div>

                        {activeTab === 'list' && (
                            <>
                                <div className="px-4 pb-2">
                                    <div className="relative">
                                        <div className="absolute left-3 top-2 text-gray-400"><Icons.Search size={18} /></div>
                                        <input type="text" className="w-full pl-9 pr-4 py-2 bg-gray-200/70 rounded-xl text-[15px] focus:bg-white focus:ring-2 focus:ring-blue-500/20 outline-none transition-all" placeholder="搜索单号/货物..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} />
                                    </div>
                                </div>
                                <div className="px-4 pb-3">
                                    <div className="bg-gray-200/70 p-1 rounded-lg flex">
                                        <button onClick={()=>setFilterType('pending')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${filterType==='pending'?'tab-active':'tab-inactive'}`}>待收货 ({packages.filter(p=>!p.verified).length})</button>
                                        <button onClick={()=>setFilterType('verified')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${filterType==='verified'?'tab-active':'tab-inactive'}`}>已入库 ({packages.filter(p=>p.verified).length})</button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {/* 主内容区域 */}
                    {activeTab === 'list' ? (
                        <div className="px-4 pt-3 space-y-3 animate-fade-in">
                            {filteredPackages.map(pkg => (
                                <div key={pkg.id} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 active:scale-[0.99] transition-transform">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="font-mono text-[16px] font-bold select-all">{pkg.tracking}</div>
                                        {pkg.verified && <div className="text-green-500"><Icons.CheckCircle /></div>}
                                    </div>
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-lg text-slate-800">{pkg.content}</span>
                                            <span className="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-bold">x{pkg.quantity || 1}</span>
                                        </div>
                                        <div className="text-xs text-gray-400">{new Date(pkg.timestamp).toLocaleDateString()}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>window.open(`https://www.baidu.com/s?wd=${pkg.tracking}`)} className="flex-1 py-2 bg-gray-50 text-blue-600 text-xs font-bold rounded-xl">查物流</button>
                                        <button onClick={()=>toggleVerify(pkg.id)} className={`flex-[1.5] py-2 text-white text-xs font-bold rounded-xl ${pkg.verified?'bg-gray-400':'bg-blue-600 shadow-lg shadow-blue-200'}`}>{pkg.verified?'撤销':'确认收货'}</button>
                                        <button onClick={()=>setDeleteTargetId(pkg.id)} className="px-3 text-gray-300 hover:text-red-500"><Icons.Trash2 /></button>
                                    </div>
                                </div>
                            ))}
                            {filteredPackages.length===0 && <div className="text-center py-10 text-gray-400 text-sm">暂无数据</div>}
                        </div>
                    ) : (
                        // --- 统计看板 ---
                        <div className="px-4 pt-4 space-y-4 animate-fade-in pb-20">
                            
                            {/* 1. 货物筛选栏 (可展开) */}
                            <div className="relative">
                                {!isGoodsExpanded ? (
                                    <div className="flex items-center gap-2">
                                        <div className="flex-1 flex gap-2 overflow-x-auto hide-scrollbar pb-1 pr-8">
                                            <button 
                                                onClick={() => setSelectedGood(null)}
                                                className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors border ${!selectedGood ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'}`}
                                            >
                                                全部货物
                                            </button>
                                            {goodsList.map(good => (
                                                <button 
                                                    key={good}
                                                    onClick={() => setSelectedGood(good)}
                                                    className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors border ${selectedGood === good ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'}`}
                                                >
                                                    {good}
                                                </button>
                                            ))}
                                        </div>
                                        {/* 展开按钮 */}
                                        <button onClick={() => setIsGoodsExpanded(true)} className="absolute right-0 top-0 bottom-1 bg-gradient-to-l from-[#F2F2F7] via-[#F2F2F7] to-transparent pl-4 flex items-center">
                                            <div className="bg-white p-1.5 rounded-full shadow-sm border border-gray-200 text-gray-500">
                                                <Icons.ChevronDown size={16} />
                                            </div>
                                        </button>
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-2xl p-3 shadow-sm border border-gray-100 animate-fade-in relative z-10">
                                        <div className="flex justify-between items-center mb-3 pb-2 border-b border-gray-50">
                                            <span className="text-xs font-bold text-gray-400">选择货物 ({goodsList.length})</span>
                                            <button onClick={() => setIsGoodsExpanded(false)} className="text-gray-400 p-1 rounded-full hover:bg-gray-100"><Icons.ChevronUp size={16}/></button>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto">
                                             <button 
                                                onClick={() => {setSelectedGood(null); setIsGoodsExpanded(false);}}
                                                className={`px-2 py-2 rounded-lg text-xs font-bold truncate border ${!selectedGood ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-50 text-gray-600 border-transparent'}`}
                                            >
                                                全部货物
                                            </button>
                                             {goodsList.map(good => (
                                                <button 
                                                    key={good}
                                                    onClick={() => {setSelectedGood(good); setIsGoodsExpanded(false);}}
                                                    className={`px-2 py-2 rounded-lg text-xs font-bold truncate border ${selectedGood === good ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-50 text-gray-600 border-transparent'}`}
                                                >
                                                    {good}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* 2. 核心数据概览 (基于 VerifiedTime 的实收统计) */}
                            <div className="grid grid-cols-3 gap-3">
                                <div className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center">
                                    <div className="text-xs text-gray-400 mb-1">今日添加</div>
                                    <div className="text-xl font-bold text-gray-700">{statsData.summary.todayAdded}</div>
                                </div>
                                <div className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-4 h-4 bg-blue-500 rounded-bl-lg"></div>
                                    <div className="text-xs text-gray-400 mb-1">今日实收</div>
                                    <div className="text-xl font-bold text-blue-600">{statsData.summary.todayReceived}</div>
                                </div>
                                <div className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 text-center">
                                    <div className="text-xs text-gray-400 mb-1">本月实收</div>
                                    <div className="text-xl font-bold text-slate-800">{statsData.summary.monthReceived}</div>
                                </div>
                            </div>

                            {/* 3. 日期导航 & 模式切换 */}
                            <div className="flex items-center justify-between bg-white rounded-2xl p-2 shadow-sm border border-gray-100">
                                <button onClick={() => navigateDate(-1)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-lg"><Icons.ChevronLeft size={20} /></button>
                                <div className="flex flex-col items-center">
                                    <span className="font-bold text-lg text-slate-800">{currentTitle}</span>
                                    <div className="flex items-center gap-3 text-xs font-medium text-gray-400 mt-0.5">
                                        <span onClick={() => setStatsMode('month')} className={`cursor-pointer ${statsMode === 'month' ? 'text-blue-600' : 'hover:text-gray-600'}`}>月视图</span>
                                        <span>|</span>
                                        <span onClick={goToToday} className="cursor-pointer text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full hover:bg-blue-100 transition-colors flex items-center gap-1"><Icons.Today size={12}/> 今天</span>
                                        <span>|</span>
                                        <span onClick={() => setStatsMode('year')} className={`cursor-pointer ${statsMode === 'year' ? 'text-blue-600' : 'hover:text-gray-600'}`}>年视图</span>
                                    </div>
                                </div>
                                <button onClick={() => navigateDate(1)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-lg"><Icons.ChevronRight size={20} /></button>
                            </div>

                            {/* 4. 主视图区域 (显示的是实收数据) */}
                            {statsMode === 'month' ? (
                                <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                                    <div className="grid grid-cols-7 mb-2 text-center text-xs text-gray-400 font-medium"><div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div></div>
                                    <div className="calendar-grid">
                                        {statsData.calendarDays.map((item, idx) => (
                                            item.empty ? <div key={idx} className="calendar-day empty"></div> : 
                                            <div key={idx} className={`calendar-day ${item.hasData ? 'active cursor-pointer hover:bg-gray-50' : ''} ${selectedDayDetail === item.date.getTime() ? 'selected' : ''} ${new Date().toDateString() === item.date.toDateString() ? 'today' : ''}`} onClick={() => item.hasData && setSelectedDayDetail(item.date.getTime())}>
                                                <span>{item.day}</span>
                                                {item.hasData && <><div className="calendar-dot"></div><span className="calendar-count">{item.count}</span></>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                                    <div className="h-64 flex items-end justify-between gap-1 pt-6 pb-2">
                                        {statsData.yearMonths.map(m => {
                                            const maxVal = Math.max(...statsData.yearMonths.map(i=>i.value), 1);
                                            const heightPct = Math.max((m.value / maxVal) * 100, 5);
                                            return (
                                                <div key={m.month} className="flex-1 flex flex-col items-center justify-end h-full group">
                                                    <div className="text-xs font-bold text-gray-500 mb-1 opacity-0 group-hover:opacity-100 transition-opacity">{m.value}</div>
                                                    <div className={`w-full max-w-[20px] rounded-t-md transition-all duration-500 ${m.value > 0 ? 'bg-blue-500' : 'bg-gray-100'}`} style={{ height: `${heightPct}%` }}></div>
                                                    <div className="text-[10px] text-gray-400 mt-2">{m.month}月</div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    <div className="text-center text-sm font-bold text-gray-600 mt-4 border-t pt-2 border-gray-50">
                                        {currentDate.getFullYear()}年 实收总计: <span className="text-blue-600 text-lg">{statsData.viewYearTotal}</span>
                                    </div>
                                </div>
                            )}

                            {/* 5. 每日详情列表 (显示实收包裹) */}
                            {selectedDayPackages.length > 0 && (
                                <div className="animate-slide-up">
                                    <div className="text-xs font-bold text-gray-400 uppercase mb-2 pl-1">
                                        {new Date(selectedDayDetail).getMonth()+1}月{new Date(selectedDayDetail).getDate()}日 实收清单
                                    </div>
                                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 divide-y divide-gray-50 overflow-hidden">
                                        {selectedDayPackages.map(pkg => (
                                            <div key={pkg.id} className="p-3 flex justify-between items-center">
                                                <div>
                                                    <div className="font-bold text-slate-700">{pkg.content} <span className="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded ml-1">x{pkg.quantity || 1}</span></div>
                                                    <div className="text-xs text-gray-400 font-mono mt-0.5">{pkg.tracking}</div>
                                                </div>
                                                <Icons.CheckCircle className="text-green-500" size={16}/>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* 添加按钮 */}
                    <button onClick={()=>setIsBatchModalOpen(true)} className="fixed bottom-8 right-5 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl shadow-blue-500/40 flex items-center justify-center active:scale-90 transition-transform z-20 pb-safe-bottom">
                        <Icons.Plus size={30} />
                    </button>

                    {/* 删除确认框 */}
                    {deleteTargetId && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/30 backdrop-blur-sm animate-fade-in" onClick={()=>setDeleteTargetId(null)}></div>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xs z-10 p-6 text-center animate-scale-up">
                                <div className="mx-auto bg-red-50 w-12 h-12 rounded-full flex items-center justify-center mb-4 text-red-500"><Icons.Trash2 size={24} /></div>
                                <h3 className="text-lg font-bold text-gray-900 mb-2">确认删除？</h3>
                                <p className="text-sm text-gray-500 mb-6">操作无法撤销。</p>
                                <div className="flex gap-3">
                                    <button onClick={()=>setDeleteTargetId(null)} className="flex-1 py-2.5 bg-gray-100 text-gray-700 font-bold rounded-xl">取消</button>
                                    <button onClick={confirmDelete} className="flex-1 py-2.5 bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-200">删除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 设置模态框 */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-fade-in" onClick={()=>setIsSettingsOpen(false)}></div>
                            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl z-10 p-5 animate-scale-up flex flex-col max-h-[80vh]">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="font-bold text-xl">设置</h2>
                                    <button onClick={()=>setIsSettingsOpen(false)} className="bg-gray-100 p-2 rounded-full"><Icons.X /></button>
                                </div>
                                <div className="space-y-4 overflow-y-auto hide-scrollbar">
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={exportBackup} className="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex flex-col items-center gap-2 active:bg-blue-50"><div className="text-blue-500"><Icons.Download /></div><span className="text-xs font-bold text-gray-600">备份 JSON</span></button>
                                        <label className="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex flex-col items-center gap-2 active:bg-orange-50 cursor-pointer"><div className="text-orange-500"><Icons.Upload /></div><span className="text-xs font-bold text-gray-600">恢复备份</span><input type="file" ref={fileInputRef} onChange={handleRestore} className="hidden" accept=".json" /></label>
                                    </div>
                                    <button onClick={exportExcel} className="w-full py-3 bg-green-50 text-green-700 font-bold rounded-2xl border border-green-100 flex justify-center items-center gap-2">导出 Excel 表格</button>
                                    <div className="pt-4 border-t border-gray-100">
                                        <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">常用货物库管理</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {goodsList.map(g => (
                                                <span key={g} onClick={()=>removeGood(g)} className="px-2 py-1 bg-gray-100 rounded-lg text-xs text-gray-600 border border-gray-200 cursor-pointer hover:bg-red-50 hover:text-red-500 transition-colors">{g}</span>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 大图预览模态框 */}
                    {imagePreview && scannedImage && (
                        <div className="fixed inset-0 z-[60] bg-black/95 flex flex-col justify-center items-center animate-fade-in" onClick={()=>setImagePreview(false)}>
                            <img src={scannedImage} className="max-w-full max-h-[85vh] object-contain transition-transform" onClick={(e)=>e.stopPropagation()} />
                            <button className="absolute top-8 right-6 text-white bg-white/20 p-2 rounded-full backdrop-blur-md" onClick={()=>setImagePreview(false)}><Icons.X size={24} /></button>
                            <div className="absolute bottom-10 text-white/70 text-sm bg-black/40 px-4 py-2 rounded-full backdrop-blur-sm">点击任意空白处关闭</div>
                        </div>
                    )}

                    {/* 批量录入模态框 */}
                    {isBatchModalOpen && (
                        <div className="fixed inset-0 z-50 bg-white flex flex-col animate-slide-up">
                            <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-20">
                                <button onClick={closeBatchModal} className="text-gray-500 font-medium">取消</button>
                                <h2 className="font-bold text-lg">批量录入</h2>
                                <button onClick={saveBatch} className="text-blue-600 font-bold">完成</button>
                            </div>
                            <div className="flex-1 overflow-y-auto bg-gray-50 p-4 pb-32">
                                <div className="bg-white rounded-2xl p-4 shadow-sm mb-4 border border-blue-100">
                                    <div className="text-xs font-bold text-blue-500 uppercase mb-2">第1步：设置默认值 (可选)</div>
                                    <div className="grid grid-cols-[2fr_1fr] gap-3 mb-3 relative">
                                        <div><input type="text" className="w-full bg-gray-100 px-3 py-2 rounded-xl text-sm font-bold outline-none" placeholder="货物名称" value={globalFill.content} onFocus={()=>{setCurrentEditingIndex('global'); setShowSuggestions(true);}} onChange={e=>setGlobalFill({...globalFill, content: e.target.value})} /></div>
                                        <div><input type="number" className="w-full bg-gray-100 px-3 py-2 rounded-xl text-center text-sm font-bold outline-none" placeholder="数量" value={globalFill.quantity} onChange={e=>setGlobalFill({...globalFill, quantity: e.target.value})} /></div>
                                        {showSuggestions && currentEditingIndex === 'global' && (
                                            <div className="absolute top-full left-0 w-2/3 bg-white shadow-xl rounded-xl z-30 border border-gray-100 max-h-40 overflow-y-auto mt-1 p-1">
                                                <div className="flex justify-between px-2 py-1 text-[10px] text-gray-400"><span>常用库</span><span onClick={()=>setShowSuggestions(false)}>关闭</span></div>
                                                {filteredGoods.map(g => (<div key={g} onMouseDown={(e)=>{e.preventDefault(); setGlobalFill({...globalFill, content: g}); setShowSuggestions(false);}} className="px-3 py-2 text-sm font-medium hover:bg-blue-50 rounded-lg cursor-pointer text-slate-700">{g}</div>))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <input type="text" placeholder="发货地" className="bg-gray-100 px-3 py-2 rounded-xl text-xs" value={globalFill.sender} onChange={e=>setGlobalFill({...globalFill, sender: e.target.value})} />
                                        <input type="tel" placeholder="手机尾号" className="bg-gray-100 px-3 py-2 rounded-xl text-xs" value={globalFill.phone} onChange={e=>setGlobalFill({...globalFill, phone: e.target.value})} />
                                    </div>
                                    <button onClick={applyGlobalToAll} className="w-full py-2 bg-blue-50 text-blue-600 font-bold text-xs rounded-xl border border-blue-100 active:bg-blue-100">应用设置</button>
                                </div>
                                <div className="text-xs font-bold text-gray-400 uppercase mb-2 pl-2">第2步：扫码并确认</div>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-3">
                                        {scannedImage ? (
                                            <div className="relative h-24 bg-gray-100 rounded-xl overflow-hidden border border-blue-200 group">
                                                <img src={scannedImage} onClick={()=>setImagePreview(true)} className="w-full h-full object-cover cursor-zoom-in" />
                                                <div className="absolute bottom-0 right-0 p-1 bg-white/90 rounded-tl-lg" onClick={(e)=>e.stopPropagation()}>
                                                   <label className="flex items-center justify-center w-8 h-8 bg-blue-50 text-blue-600 rounded-lg cursor-pointer hover:bg-blue-100">
                                                       <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} disabled={analyzing} />
                                                       <Icons.Camera size={18} />
                                                   </label>
                                                </div>
                                                <button onClick={(e)=>{e.stopPropagation(); setScannedImage(null);}} className="absolute top-0 right-0 p-1.5 bg-red-500/80 text-white rounded-bl-lg hover:bg-red-600 transition-colors"><Icons.X size={14} /></button>
                                                <div className="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity"><span className="bg-black/60 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm"><Icons.Maximize size={12} /> 查看大图</span></div>
                                            </div>
                                        ) : (
                                            <label className="bg-white border-2 border-dashed border-gray-300 rounded-xl h-24 flex flex-col items-center justify-center text-gray-400 active:bg-gray-50 active:border-blue-400 transition-colors relative cursor-pointer">
                                                <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} disabled={analyzing} />
                                                {analyzing ? <span className="text-xs font-bold animate-pulse text-blue-500">识别中...</span> : <><Icons.Camera size={24} /><span className="text-xs font-bold mt-1">拍照扫条码</span></>}
                                            </label>
                                        )}
                                        <div className="bg-white border border-gray-200 rounded-xl p-3 flex flex-col justify-between">
                                            <input type="text" placeholder="手动输入单号" className="w-full text-xs border-b border-gray-100 py-1 outline-none font-mono" value={manualInputCode} onChange={e=>setManualInputCode(e.target.value)} />
                                            <button onClick={addManualCode} className="w-full bg-gray-800 text-white text-xs font-bold py-1.5 rounded-lg mt-2">添加</button>
                                        </div>
                                    </div>
                                    {batchItems.map((item, index) => (
                                        <div key={item._tempId || index} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-2 relative">
                                            <div className="flex justify-between items-center"><span className="font-mono font-bold text-slate-800">{item.tracking}</span><button type="button" onClick={(e)=>{e.stopPropagation(); removeBatchItem(index);}} className="text-gray-300 hover:text-red-500"><Icons.X size={16} /></button></div>
                                            <div className="grid grid-cols-[2fr_1fr] gap-3">
                                                <div className="relative">
                                                    <input type="text" className="w-full bg-gray-50 px-3 py-2 rounded-lg text-sm font-medium outline-none" placeholder="货物名称" value={item.content} onFocus={()=>{setCurrentEditingIndex(index); setShowSuggestions(true);}} onChange={(e)=>updateBatchItem(index, 'content', e.target.value)} />
                                                    {showSuggestions && currentEditingIndex === index && (
                                                        <div className="absolute top-full left-0 w-full bg-white shadow-lg rounded-lg z-20 border border-gray-100 max-h-32 overflow-y-auto mt-1">
                                                            {filteredGoods.map(g => (<div key={g} onMouseDown={(e)=>{e.preventDefault(); updateBatchItem(index, 'content', g); setShowSuggestions(false);}} className="px-3 py-2 text-xs font-medium hover:bg-blue-50 cursor-pointer">{g}</div>))}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex items-center bg-gray-50 rounded-lg px-2"><span className="text-xs text-gray-400 mr-1">x</span><input type="number" className="w-full bg-transparent text-sm font-bold outline-none" value={item.quantity} onChange={(e)=>updateBatchItem(index, 'quantity', e.target.value)} /></div>
                                            </div>
                                        </div>
                                    ))}
                                    {batchItems.length === 0 && <div className="text-center py-4 text-xs text-gray-400">暂无单号</div>}
                                </div>
                            </div>
                            <div className="p-4 bg-white border-t border-gray-100 safe-area-bottom pb-safe-bottom">
                                <button onClick={saveBatch} className="w-full bg-blue-600 text-white font-bold text-lg py-3 rounded-2xl shadow-lg shadow-blue-200 active:scale-[0.98] transition-transform">保存 ({batchItems.length})</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BatchScannerStats />);
    </script>
</body>
</html>